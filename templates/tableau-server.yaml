AWSTemplateFormatVersion: '2010-09-09'
Description: "AWS CloudFormation Template: Deploys infrastructure for Tableau Server"
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: AWS Environment and Machine Configuration
        Parameters:
        - AMIOS
        - BastionSecurityGroup
        - InstanceType
        - KeyPairName
        - PublicSubnetIds
        - PrivateSubnetIds
        - SourceCIDR
        - VpcCidr
        - VpcId
        - ConfigRecorder
        - ConfigDeliveryChannel
      - Label:
          default: Server DNS configuration
        Parameters:
        - AWSHostedZoneID
        - AWSPublicFQDN
        - SSLCertificateARN
      - Label:
          default: Secrets
        Parameters:
        - Username
        - Password
        - TableauServerAdminUser
        - TableauServerAdminPassword
      - Label:
          default: Registration
        Parameters:
        - AcceptEULA
        - TableauServerLicenseKey
        - RegFirstName
        - RegLastName
        - RegEmail
        - RegCompany
        - RegTitle
        - RegDepartment
        - RegIndustry
        - RegPhone
        - RegCity
        - RegState
        - RegZip
        - RegCountry
      - Label:
          default: AWS Quick Start Configuration
        Parameters:
        - QSS3BucketName
        - QSS3KeyPrefix
        - QSTagKey
        - QSTagValue
    ParameterLabels:
      AMIOS:
        default: AMI Operating System
      AWSHostedZoneID:
        default: DNS Zone ID
      AWSPublicFQDN:
        default: Full DNS Name for Tableau Server
      AcceptEULA:
        default: Accept Tableau End User License Agreement
      BastionSecurityGroup:
        default: Bastion Host Security Group ID
      ConfigRecorder:
        default: AWS Config Recorder ARN
      ConfigDeliveryChannel:
        default: AWS Config Delivery Channel ARN
      InstanceType:
        default: Tableau Server instance type
      KeyPairName:
        default: Key Pair Name
      Password:
        default: Tableau Services Manager (TSM) administrator password
      PublicSubnetIds:
        default: Public Subnet IDs in your VPC
      PrivateSubnetIds:
        default: Private Subnet IDs in your VPC
      QSS3BucketName:
        default: Quick Start S3 Bucket Name
      QSS3KeyPrefix:
        default: Quick Start S3 Key Prefix
      QSTagKey:
        default: Quick Start Tag key
      QSTagValue:
        default: Quick Start Tag value
      RegCity:
        default: City
      RegCompany:
        default: Company
      RegCountry:
        default: Country
      RegDepartment:
        default: Department
      RegEmail:
        default: Email Address
      RegFirstName:
        default: First Name
      RegIndustry:
        default: Industry
      RegLastName:
        default: Last Name
      RegPhone:
        default: Phone
      RegState:
        default: State
      RegTitle:
        default: Title
      RegZip:
        default: Zip/Postal Code
      SourceCIDR:
        default: Source CIDR for Access
      SSLCertificateARN:
        default: SSL Certificate ARN (Requires matching DNS name)
      TableauServerAdminPassword:
        default: Tableau Server administrator password
      TableauServerAdminUser:
        default: Tableau Server administrator username
      TableauServerLicenseKey:
        default: Tableau Activation Key
      Username:
        default: Tableau Services Manager (TSM) administrator username
      VpcCidr:
        default: VPC CIDR Block
      VpcId:
        default: VPC ID

Parameters:
  AMIOS:
    AllowedValues:
      - Amazon-Linux-2
      - CentOS-7-HVM
      - Ubuntu-Server-16.04-LTS-HVM
      - Windows-Server-2012-R2
    Description: The operating system (Microsoft Windows Server, CentOS, Ubuntu Server, or Amazon Linux 2) on the EC2 instance where Tableau Server will be installed. If you choose CentOS, make sure that you have a subscription to the CentOS AMI in AWS Marketplace
    Default: Amazon-Linux-2
    Type: String
  AWSHostedZoneID:
    Description: DNS Zone ID to contain the server's DNS entry.
    Type: String
  AWSPublicFQDN:
    Description: Tableau Server portal will be reachable at this address.
    Type: String
  AcceptEULA:
    AllowedPattern: 'No'
    AllowedValues:
    - 'Yes'
    - 'No'
    Default: 'Yes'
    Description: 'View the EULA at the Link: https://www.tableau.com/eula'
    Type: String
  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup::Id
    Description: EC2 Security Group for the bastion host.
  ConfigRecorder:
    Type: String
    Default: ""
    Description: Config Recorder in your AWS Region. Leaving empty will try to create a new recorder.
  ConfigDeliveryChannel:
    Type: String
    Default: ""
    Description: Config Delivery Channel in your AWS Region. Leaving empty will try to create a new recorder. Required if you specify Config Recorder
  InstanceType:
    AllowedValues:
    - c5.4xlarge
    - c5d.4xlarge
    - c4.4xlarge
    - m4.4xlarge
    - m5.4xlarge
    - r5d.4xlarge
    ConstraintDescription: must be a valid EC2 instance type.
    Default: m5.4xlarge
    Description: The EC2 instance type where Tableau Server will be installed.
    Type: String
  KeyPairName:
    AllowedPattern: ".+"
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    Type: AWS::EC2::KeyPair::KeyName
  Password:
    Description: Tableau Services Manager (TSM) administrator password
    Type: String
    NoEcho: true
    AllowedPattern: "^(?=[a-zA-Z0-9#@$?!]{8,}$)(?=.*?[a-z])(?=.*?[A-Z])(?=.*?[0-9]).*"
    MinLength: '8'
  PublicSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Public subnets in your VPC.
  PrivateSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Private subnets in your VPC.
  VpcCidr:
    Type: String
    Description: VPC CIDR Block.
  QSS3BucketName:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
    Default: aws-quickstart
    Description: S3 bucket name for the Quick Start assets. This string can include
      numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start
      or end with a hyphen (-).
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/).
    Default: quickstart-tableau-server-healthcare/
    Description: S3 key prefix for the Quick Start assets. Quick Start key prefix
      can include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    Type: String
  QSTagKey:
    Type: String
    Description: Tag key to identify resources from this Quick Start.
    Default: QuickStartID
  QSTagValue:
    Type: String
    Description: Tag value to identify resources from this Quick Start.
    Default: TableauServerHealthcare
  RegCity:
    Description: City
    MinLength: 1
    Type: String
  RegCompany:
    Description: Company
    MinLength: 1
    Type: String
  RegCountry:
    Description: Country
    MinLength: 1
    Type: String
  RegDepartment:
    Description: Department
    MinLength: 1
    Type: String
  RegEmail:
    Description: Email
    MinLength: 1
    Type: String
  RegFirstName:
    Description: First Name
    MinLength: 1
    Type: String
  RegIndustry:
    Description: Industry
    MinLength: 1
    Type: String
  RegLastName:
    Description: Last Name
    MinLength: 1
    Type: String
  RegPhone:
    Description: Phone
    MinLength: 1
    Type: String
  RegState:
    Description: State
    MinLength: 1
    Type: String
  RegTitle:
    Description: Title
    MinLength: 1
    Type: String
  RegZip:
    Description: ZIP/Postal Code
    MinLength: 1
    Type: String
  SourceCIDR:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$"
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x.
    Description: IP address/range to allow access from
    Type: String
  SSLCertificateARN:
    Type: String
    Default: ""
    Description: The Amazon Resource Name for the existing SSL cert you wish to use; empty for none
  TableauServerAdminPassword:
    Description: The password of the initial administrator for Tableau Server
    MinLength: 1
    NoEcho: true
    Type: String
  TableauServerAdminUser:
    Description: The name of the initial administrator for Tableau Server
    MinLength: 1
    Type: String
  TableauServerLicenseKey:
    Description: License Key
    Type: String
  Username:
    Description: Tableau Services Manager (TSM) administrator username (cannot be
      Administrator)
    Type: String
    AllowedPattern: "[A-Za-z0-9]+"
    MaxLength: '30'
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: Amazon VPC ID

Mappings:
  AWSAMIRegionMap:
    AMI:
      CENTOS7HVM: CentOS Linux 7 x86_64 HVM 1805_01
      US1604HVM: Ubuntu 16.04 LTS HVM 20180912
      WS2012R2: Windows_Server-2012-R2_RTM-English-64Bit-Base-2018.09.15
      ALINUX2: Amazon-Linux-2 LTS amzn2-ami-hvm-2.0.20180924-x86_64-gp2 
    ap-northeast-1:
      CENTOS7HVM: ami-8e8847f1
      US1604HVM: ami-06c43a7df16e8213c
      WS2012R2: ami-0f94c740726599c3a
      ALINUX2: ami-06962fe7164c1fe7b
    ap-northeast-2:
      CENTOS7HVM: ami-bf9c36d1
      US1604HVM: ami-0e0f4ff1154834540
      WS2012R2: ami-0f033ac3427fcdad0
      ALINUX2: ami-02e495c61af26da99
    ap-south-1:
      CENTOS7HVM: ami-1780a878
      US1604HVM: ami-04ea996e7a3e7ad6b
      WS2012R2: ami-0d5f824867e8aeaf6
      ALINUX2: ami-0b173ae0d9e71699a
    ap-southeast-1:
      CENTOS7HVM: ami-8e0205f2
      US1604HVM: ami-0eb1f21bbd66347fe
      WS2012R2: ami-0f42104b50a572747
      ALINUX2: ami-0f67499750e64577a
    ap-southeast-2:
      CENTOS7HVM: ami-d8c21dba
      US1604HVM: ami-0789a5fb42dcccc10
      WS2012R2: ami-06f2dbd8cdf99fd40
      ALINUX2: ami-0e2b2114bf2fac7d8
    ca-central-1:
      CENTOS7HVM: ami-e802818c
      US1604HVM: ami-0f2cb2729acf8f494
      WS2012R2: ami-0bc1f82c15f6cb011
      ALINUX2: ami-0c612fea430136cb0
    eu-central-1:
      CENTOS7HVM: ami-dd3c0f36
      US1604HVM: ami-086a09d5b9fa35dc7
      WS2012R2: ami-09f85c4c3e4a1ca3b
      ALINUX2: ami-0e82b8b6afa30f2cd
    eu-west-1:
      CENTOS7HVM: ami-3548444c
      US1604HVM: ami-0773391ae604c49a4
      WS2012R2: ami-019526e560b1c9df4
      ALINUX2: ami-0eafb5ee12a2cbffc
    eu-west-2:
      CENTOS7HVM: ami-00846a67
      US1604HVM: ami-061a2d878e5754b62
      WS2012R2: ami-068ee8cde1f60ca7f
      ALINUX2: ami-0135b45434a538069
    eu-west-3:
      CENTOS7HVM: ami-262e9f5b
      US1604HVM: ami-075b44448d2276521
      WS2012R2: ami-014aa0eab0ec618d6
      ALINUX2: ami-07e5d89c9e173f360
    sa-east-1:
      CENTOS7HVM: ami-cb5803a7
      US1604HVM: ami-0318cb6e2f90d688b
      WS2012R2: ami-04fddd42220f1829a
      ALINUX2: ami-0e4c9b46b89ddd90c
    us-east-1:
      CENTOS7HVM: ami-9887c6e7
      US1604HVM: ami-059eeca93cf09eebd
      WS2012R2: ami-04b06bdb58cae787d
      ALINUX2: ami-0e6d2e8684d4ccb3e
    us-east-2:
      CENTOS7HVM: ami-9c0638f9
      US1604HVM: ami-0782e9ee97725263d
      WS2012R2: ami-08c59800a21429561
      ALINUX2: ami-0785b10e84f9dbd4f
    us-west-1:
      CENTOS7HVM: ami-4826c22b
      US1604HVM: ami-0ad16744583f21877
      WS2012R2: ami-08f6003bf4d50fe60
      ALINUX2: ami-01eb1709d6ad69035
    us-west-2:
      CENTOS7HVM: ami-3ecc8f46
      US1604HVM: ami-0e32ec5bc225539f5
      WS2012R2: ami-0d1a1bbc1331e97f7
      ALINUX2: ami-0fcd5791ba781e98f
  AWSAMINameMap:
    CentOS-7-HVM:
      Code: CENTOS7HVM
    Ubuntu-Server-16.04-LTS-HVM:
      Code: US1604HVM
    Windows-Server-2012-R2: 
      Code: WS2012R2
    Amazon-Linux-2:
      Code: ALINUX2

Conditions:
  IsWindows: !Equals [ !Ref AMIOS, Windows-Server-2012-R2 ]
  IsLinux: !Not [ Condition: IsWindows ]
  IsUbuntu: !Equals [ !Ref AMIOS,  Ubuntu-Server-16.04-LTS-HVM ]
  IsCentosOrAmazonLinux: !Or [ !Equals [ !Ref AMIOS,  CentOS-7-HVM ], !Equals [ !Ref AMIOS, Amazon-Linux-2 ] ]
  NoSSLCertificate: !Equals [ '', !Ref SSLCertificateARN ]

Resources:
  # Create a log bucket
  LogStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/logging.yaml
      Parameters:
        ConfigRecorderName: !Ref ConfigRecorder
        ConfigDeliveryChannelName: !Ref ConfigDeliveryChannel
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        QSTagKey: !Ref QSTagKey
        QSTagValue: !Sub ${QSTagValue}-${AWS::StackName}

  # Create the ELB
  ElbStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: LogStack
    Properties:
      TemplateURL: !Sub https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/encrypted-elb.yaml
      Parameters:
        AWSHostedZoneID: !Ref AWSHostedZoneID
        AWSPublicFQDN: !Ref AWSPublicFQDN
        LogBucket: !GetAtt LogStack.Outputs.LogBucket
        PublicSubnetIds: !Join [ ',', !Ref PublicSubnetIds ]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        QSTagKey: !Ref QSTagKey
        QSTagValue: !Sub ${QSTagValue}-${AWS::StackName}
        SourceCIDR: !Ref SourceCIDR
        SSLCertificateARN: !Ref SSLCertificateARN
        VpcCidr: !Ref VpcCidr
        VpcId: !Ref VpcId

  # Encrypt the AMI root volume
  EncryptAmiStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
    - ElbStack
    - LogStack
    Properties:
      TemplateURL: !Sub https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/encrypt-ami.yaml
      Parameters:
        AmiId: !FindInMap [ AWSAMIRegionMap , !Ref "AWS::Region", !FindInMap [ AWSAMINameMap, !Ref AMIOS, Code ] ]
        AmiRegion: !Ref "AWS::Region"
        SubnetId: !Select [ 0, !Ref PrivateSubnetIds ]
        QSTagKey: !Ref QSTagKey
        QSTagValue: !Sub ${QSTagValue}-${AWS::StackName}

  # Configure Instance Security Group
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable SSH/RDP access and HTTPS from the load balancer only
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: !If [ IsWindows, 3389, 22 ]
        ToPort: !If [ IsWindows, 3389, 22 ]
        SourceSecurityGroupId: !Ref BastionSecurityGroup
      - IpProtocol: tcp
        FromPort: 8850
        ToPort: 8850
        SourceSecurityGroupId: !GetAtt ElbStack.Outputs.ElbSecurityGroup
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        SourceSecurityGroupId: !GetAtt ElbStack.Outputs.ElbSecurityGroup
      Tags:
      - Key: !Ref QSTagKey
        Value: !Sub ${QSTagValue}-${AWS::StackName}
      VpcId: !Ref VpcId

  TableauServerInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: CreateTags
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - ec2:Describe*
            - ec2:CreateTags
            Resource: "*"
  TableauServerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
      - !Ref TableauServerInstanceRole

  TableauServerWindows:
    Type: AWS::CloudFormation::Stack
    Condition: IsWindows
    DependsOn: 
    - EncryptAmiStack
    - ElbStack
    - TableauServerInstanceProfile
    Properties:
      TemplateURL: !Sub https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/tableau-server-windows.yaml
      Parameters:
        AcceptEULA: !Ref AcceptEULA
        ElbTargetGroups: !GetAtt ElbStack.Outputs.ElbTargetGroupHTTPS
        ImageId: !GetAtt EncryptAmiStack.Outputs.EncryptedAmiId
        InstanceSecurityGroup: !Ref InstanceSecurityGroup
        InstanceType: !Ref InstanceType
        TableauServerInstanceProfile: !Ref TableauServerInstanceProfile
        KeyPairName: !Ref KeyPairName
        Password: !Ref Password
        PrivateSubnetIds: !Join [',', !Ref PrivateSubnetIds]
        RegCity: !Ref RegCity
        RegCompany: !Ref RegCompany
        RegCountry: !Ref RegCountry
        RegDepartment: !Ref RegDepartment
        RegEmail: !Ref RegEmail
        RegFirstName: !Ref RegFirstName
        RegIndustry: !Ref RegIndustry
        RegLastName: !Ref RegLastName
        RegPhone: !Ref RegPhone
        RegState: !Ref RegState
        RegTitle: !Ref RegTitle
        RegZip: !Ref RegZip
        QSTagKey: !Ref QSTagKey
        QSTagValue: !Sub ${QSTagValue}-${AWS::StackName}
        TableauServerAdminUser: !Ref TableauServerAdminUser
        TableauServerAdminPassword: !Ref TableauServerAdminPassword
        TableauServerLicenseKey: !Ref TableauServerLicenseKey
        Username: !Ref Username

  TableauServerUbuntu:
    Type: AWS::CloudFormation::Stack
    Condition: IsUbuntu
    DependsOn: 
    - EncryptAmiStack
    - ElbStack
    Properties:
      TemplateURL: !Sub https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/tableau-server-ubuntu.yaml
      Parameters:
        AcceptEULA: !Ref AcceptEULA
        ElbTargetGroups: !GetAtt ElbStack.Outputs.ElbTargetGroupHTTPS
        ImageId: !GetAtt EncryptAmiStack.Outputs.EncryptedAmiId
        InstanceSecurityGroup: !Ref InstanceSecurityGroup
        InstanceType: !Ref InstanceType
        TableauServerInstanceProfile: !Ref TableauServerInstanceProfile
        KeyPairName: !Ref KeyPairName
        Password: !Ref Password
        PrivateSubnetIds: !Join [',', !Ref PrivateSubnetIds ]
        RegCity: !Ref RegCity
        RegCompany: !Ref RegCompany
        RegCountry: !Ref RegCountry
        RegDepartment: !Ref RegDepartment
        RegEmail: !Ref RegEmail
        RegFirstName: !Ref RegFirstName
        RegIndustry: !Ref RegIndustry
        RegLastName: !Ref RegLastName
        RegPhone: !Ref RegPhone
        RegState: !Ref RegState
        RegTitle: !Ref RegTitle
        RegZip: !Ref RegZip
        QSTagKey: !Ref QSTagKey
        QSTagValue: !Sub ${QSTagValue}-${AWS::StackName}
        TableauServerAdminUser: !Ref TableauServerAdminUser
        TableauServerAdminPassword: !Ref TableauServerAdminPassword
        TableauServerLicenseKey: !Ref TableauServerLicenseKey
        Username: !Ref Username

  TableauServerCentosAmazonLinux:
    Type: AWS::CloudFormation::Stack
    Condition: IsCentosOrAmazonLinux
    DependsOn: 
    - EncryptAmiStack
    - ElbStack
    Properties:
      TemplateURL: !Sub https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/tableau-server-centos-amazonlinux.yaml
      Parameters:
        AMIOS: !Ref AMIOS
        AcceptEULA: !Ref AcceptEULA
        ElbTargetGroups: !GetAtt ElbStack.Outputs.ElbTargetGroupHTTPS
        ImageId: !GetAtt EncryptAmiStack.Outputs.EncryptedAmiId
        InstanceSecurityGroup: !Ref InstanceSecurityGroup
        InstanceType: !Ref InstanceType
        TableauServerInstanceProfile: !Ref TableauServerInstanceProfile
        KeyPairName: !Ref KeyPairName
        Password: !Ref Password
        PrivateSubnetIds: !Join [',', !Ref PrivateSubnetIds ]
        RegCity: !Ref RegCity
        RegCompany: !Ref RegCompany
        RegCountry: !Ref RegCountry
        RegDepartment: !Ref RegDepartment
        RegEmail: !Ref RegEmail
        RegFirstName: !Ref RegFirstName
        RegIndustry: !Ref RegIndustry
        RegLastName: !Ref RegLastName
        RegPhone: !Ref RegPhone
        RegState: !Ref RegState
        RegTitle: !Ref RegTitle
        RegZip: !Ref RegZip
        QSTagKey: !Ref QSTagKey
        QSTagValue: !Sub ${QSTagValue}-${AWS::StackName}
        TableauServerAdminUser: !Ref TableauServerAdminUser
        TableauServerAdminPassword: !Ref TableauServerAdminPassword
        TableauServerLicenseKey: !Ref TableauServerLicenseKey
        Username: !Ref Username

Outputs:
  LoadBalancerDNSName:
    Value: !GetAtt ElbStack.Outputs.ElbDns
    Description: DNS Name for the load balancer
  RecordSet: 
    Value: !GetAtt ElbStack.Outputs.RecordSet
    Description: Domain Name of the Record Set
  TableauServerURL:
    Description: Public DNS name to reach cluster
    Value: !Sub https://${AWSPublicFQDN}
  TSMUrl:
    Description: URL to access TSM GUI. Accessible via Bastion Host
    Value: !Sub https://${AWSPublicFQDN}:8850